{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Update Profile{% endblock %}

{% block content %}
<div class="max-w-md mx-auto p-6 bg-white rounded-3xl shadow-lg mt-10 relative">

  <!-- Top bar with Back to Dashboard and Logout -->
  <div class="flex justify-between items-center mb-6">
    <!-- Back to Dashboard link -->
    <a href="{% url 'student:dashboard' %}" 
       class="text-purple-700 font-semibold hover:underline">
      &larr; Back to Dashboard
    </a>

    <!-- Logout button -->
    <form action="{% url 'logout' %}" method="post" class="inline">
      {% csrf_token %}
      <button type="submit" 
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
        Logout
      </button>
    </form>
  </div>

  <h2 class="text-2xl font-bold mb-6 text-purple-700 text-center">Update Your Profile</h2>

  <!-- Display email as read-only text -->
  <div class="mb-6">
    <label class="block font-semibold text-gray-700 mb-1">Email</label>
    <p class="p-3 bg-gray-100 rounded border border-gray-300 select-text">{{ request.user.email }}</p>
  </div>

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Profile Picture Field -->
    <div class="mb-6">
      <label for="{{ form.profile_picture.id_for_label }}" class="block font-semibold text-gray-700 mb-2">Profile Picture</label>

      {% if request.user.profile_picture %}
        <img id="profilePicPreview" src="{{ request.user.profile_picture.url }}" alt="Current Profile Picture" class="h-24 w-24 rounded-full object-cover mb-3 border border-gray-300" />
      {% else %}
        <img id="profilePicPreview" src="{% static 'images/default_avatar.png' %}" alt="Default Avatar" class="h-24 w-24 rounded-full object-cover mb-3 border border-gray-300" />
      {% endif %}

      {{ form.profile_picture|add_class:"w-full" }}

      {% for error in form.profile_picture.errors %}
        <p class="text-red-600 text-sm mt-1">{{ error }}</p>
      {% endfor %}
    </div>

    <!-- Other Fields -->
    {% for field in form %}
      {% if field.name != 'email' and field.name != 'profile_picture' %}
        <div class="mb-4">
          <label for="{{ field.id_for_label }}" class="block font-semibold text-gray-700 mb-1">{{ field.label }}</label>
          {{ field|add_class:"w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" }}
          {% if field.help_text %}
            <p class="text-sm text-gray-500 mt-1">{{ field.help_text }}</p>
          {% endif %}
          {% for error in field.errors %}
            <p class="text-red-600 text-sm mt-1">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    <button type="submit" class="w-full py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
      Save Changes
    </button>
  </form>
</div>

<script>
  // Preview selected profile picture before upload
  const profileInput = document.getElementById('{{ form.profile_picture.id_for_label }}');
  const profilePreview = document.getElementById('profilePicPreview');

  if (profileInput) {
    profileInput.addEventListener('change', function(event) {
      const [file] = profileInput.files;
      if (file) {
        profilePreview.src = URL.createObjectURL(file);
      }
    });
  }
</script>
{% endblock %}
