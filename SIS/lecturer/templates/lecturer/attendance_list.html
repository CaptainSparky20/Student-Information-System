{% extends 'lecturer/base_lecturer.html' %}
{% load static %}

{% block title %}Take Attendance{% endblock %}
{% block lecturer_content %}

<!-- Confirmation Messages -->
{% if messages %}
  <div id="msg-confirm" class="mb-6">
    {% for message in messages %}
      <div class="bg-emerald-600/90 text-white rounded-lg shadow p-4 flex items-center justify-between animate-fade-in">
        <span>{{ message }}</span>
        <button onclick="this.parentElement.style.display='none'" class="ml-4 text-xl font-bold leading-none" aria-label="Close">&times;</button>
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      const msg = document.getElementById("msg-confirm");
      if(msg) msg.style.display = 'none';
    }, 3500);
  </script>
{% endif %}

<div class="max-w-6xl mx-auto bg-white/10 backdrop-blur-2xl rounded-2xl shadow-2xl p-8 border border-white/30 mb-8 transition-all">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <h2 class="text-2xl font-semibold text-white text-center sm:text-left flex items-center gap-2">
      <svg class="w-7 h-7 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
      Take Attendance
    </h2>
    <div class="relative w-full sm:w-80">
      <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      </span>
      <input
        id="attendance-search"
        type="text"
        placeholder="Search student, course or class..."
        class="bg-white/30 text-white placeholder:text-gray-300 rounded pl-10 pr-3 py-2 border border-white/20 focus:outline-none focus:ring focus:ring-blue-500 w-full transition"
      />
    </div>
  </div>

  <!-- Date Picker -->
  <form method="post" action="{% url 'lecturer:attendance_list' %}">
    {% csrf_token %}
    <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
      <label for="attendance-date" class="text-white font-medium whitespace-nowrap">Attendance Date:</label>
      <input
        id="attendance-date"
        name="date"
        type="date"
        value="{{ selected_date|default:today }}"
        class="rounded-lg px-4 py-2 border border-white/20 bg-white/20 text-white focus:outline-none focus:ring focus:ring-blue-500"
        max="{{ today }}"
        required
      />
    </div>

    <div class="overflow-x-auto rounded-lg">
      <table class="w-full table-auto border-collapse bg-white/5 text-white">
        <thead class="bg-white/10 sticky top-0 z-10">
          <tr>
            <th class="p-3 cursor-pointer select-none" onclick="sortTable(0)">Student <svg class="inline w-4 h-4 ml-1 text-gray-400 sort-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></th>
            <th class="p-3 cursor-pointer select-none" onclick="sortTable(1)">Course <svg class="inline w-4 h-4 ml-1 text-gray-400 sort-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></th>
            <th class="p-3 cursor-pointer select-none" onclick="sortTable(2)">Class <svg class="inline w-4 h-4 ml-1 text-gray-400 sort-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></th>
            <th class="p-3 text-center">Present</th>
            <th class="p-3 text-center">Absent</th>
            <th class="p-3 text-center">Quick</th>
          </tr>
        </thead>
        <tbody id="attendance-tbody" class="divide-y divide-white/10">
          {% for enrollment in enrollments %}
          <tr>
            <td class="p-3 whitespace-nowrap">{{ enrollment.student.user.get_full_name }}</td>
            <td class="p-3 whitespace-nowrap">{{ enrollment.course.name }}</td>
            <td class="p-3 whitespace-nowrap">{{ enrollment.course.classroom|default:"-" }}</td>
            <td class="p-3 text-center">
              <input type="radio" name="status_{{ enrollment.id }}" value="present" class="accent-green-600 scale-125"
                id="present_{{ enrollment.id }}"
                {% if enrollment.attendance_selected_date == "present" %}checked{% endif %}>
            </td>
            <td class="p-3 text-center">
              <input type="radio" name="status_{{ enrollment.id }}" value="absent" class="accent-red-600 scale-125"
                id="absent_{{ enrollment.id }}"
                {% if enrollment.attendance_selected_date == "absent" %}checked{% endif %}>
            </td>
            <td class="p-3 text-center">
              <form method="post" action="{% url 'lecturer:attendance_list' %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="date" value="{{ selected_date|default:today }}">
                <input type="hidden" name="single_enrollment_id" value="{{ enrollment.id }}">
                <input type="hidden" name="single_status" id="single_status_{{ enrollment.id }}" value="">
                <button type="submit"
                  onclick="
                    var checked = document.querySelector('input[name=status_{{ enrollment.id }}]:checked');
                    if(checked) {
                      document.getElementById('single_status_{{ enrollment.id }}').value = checked.value;
                      return true;
                    }
                    alert('Please select Present/Absent.');
                    return false;
                  "
                  class="inline-block bg-blue-700/80 hover:bg-blue-800 text-white font-medium px-4 py-2 rounded-lg transition duration-200 shadow"
                >Mark</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-gray-300 p-6">No enrollments found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if enrollments %}
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-8">
      <button type="submit"
        class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-semibold shadow transition-all duration-200">
        Submit Attendance for Selected Date
      </button>
      <a href="{% url 'lecturer:attendance_history' %}" class="inline-block text-blue-400 hover:underline text-base">
        View Past Attendance
      </a>
    </div>
    {% endif %}
  </form>
</div>

<script>
  // Live search filter (search by student, course, or class)
  document.getElementById("attendance-search").addEventListener("keyup", function () {
    let value = this.value.toLowerCase();
    document.querySelectorAll("#attendance-tbody tr").forEach(function (row) {
      let student = row.children[0].innerText.toLowerCase();
      let course = row.children[1].innerText.toLowerCase();
      let classroom = row.children[2].innerText.toLowerCase();
      row.style.display = (student.includes(value) || course.includes(value) || classroom.includes(value)) ? "" : "none";
    });
  });

  // Table Sort Functionality
  let currentSortCol = null;
  let currentSortAsc = true;
  function sortTable(col) {
    const tbody = document.getElementById('attendance-tbody');
    let rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.children.length > 1);
    if (currentSortCol === col) currentSortAsc = !currentSortAsc;
    else {
      currentSortCol = col;
      currentSortAsc = true;
    }
    rows.sort((a, b) => {
      let x = a.children[col].innerText.toLowerCase();
      let y = b.children[col].innerText.toLowerCase();
      if (x < y) return currentSortAsc ? -1 : 1;
      if (x > y) return currentSortAsc ? 1 : -1;
      return 0;
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
    document.querySelectorAll('.sort-arrow').forEach((el, idx) => {
      el.style.opacity = (idx === col) ? "1" : "0.3";
      el.style.transform = (currentSortAsc ? "rotate(0deg)" : "rotate(180deg)");
    });
  }
</script>

{% endblock %}
